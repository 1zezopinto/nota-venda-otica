<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nota de Venda - Ótica</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-xl font-bold mb-4">Preencher Nota de Venda</h1>
    <form id="form" class="space-y-4">
      <input name="cliente" placeholder="Cliente" class="w-full border p-2 rounded" required/>
      <input name="cpf" id="cpf" placeholder="CPF" class="w-full border p-2 rounded" required/>
      <input name="paciente" placeholder="Paciente" class="w-full border p-2 rounded" required/>
      <input name="bairro" placeholder="Bairro" class="w-full border p-2 rounded" required/>
      <input name="endereco" placeholder="Endereço" class="w-full border p-2 rounded" required/>
      <input name="cidade" placeholder="Cidade" class="w-full border p-2 rounded" required/>
      <input name="estado" placeholder="Estado" class="w-full border p-2 rounded" required/>
      <label class="block">Data da Compra:
        <input type="date" name="dataCompra" class="w-full border p-2 rounded" required/>
      </label>
      <label class="block">Previsão de Entrega:
        <input type="date" name="prevEntrega" class="w-full border p-2 rounded" required/>
      </label>
      <label class="block mb-2">Médico:
        <select name="medico" id="medico" class="w-full border p-2 rounded" required>
          <option value="">Selecione um Médico</option>
          <option>Dr. Kleber</option>
          <option>Dr. Edu Silva</option>
          <option>Dr. Reginaldo</option>
          <option>Dr. Waldemar Ribeiro</option>
          <option>Opto. Marcos Vinícius</option>
          <option>OPto. Izabela Prago</option>
          <option>Opto. Mary Matos</option>
          <option>Opto. Andréia</option>
          <option>Opto. Albertina</option>
        </select>
      </label>

      <label class="block mt-2">Ou adicione um novo médico:
        <input name="novo_medico" id="novo_medico" type="text" placeholder="Digite o nome do médico" class="w-full border p-2 rounded" />
      </label>


      <h2 class="text-lg font-semibold mt-6">LONGE</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h3 class="font-medium">OD</h3>
          <input name="longe_od_esferico" placeholder="Esférico OD" class="w-full border p-2 rounded" />
          <input name="longe_od_cilindrico" placeholder="Cilíndrico OD" class="w-full border p-2 rounded mt-2" />
          <input name="longe_od_eixo" placeholder="Eixo OD" class="w-full border p-2 rounded mt-2" />
          <input name="longe_od_dnp_altura" placeholder="DNP/Altura OD" class="w-full border p-2 rounded mt-2" />
          <input name="longe_od_adicao" placeholder="Adição OD" class="w-full border p-2 rounded mt-2" />
        </div>
        <div>
          <h3 class="font-medium">OE</h3>
          <input name="longe_oe_esferico" placeholder="Esférico OE" class="w-full border p-2 rounded" />
          <input name="longe_oe_cilindrico" placeholder="Cilíndrico OE" class="w-full border p-2 rounded mt-2" />
          <input name="longe_oe_eixo" placeholder="Eixo OE" class="w-full border p-2 rounded mt-2" />
          <input name="longe_oe_dnp_altura" placeholder="DNP/Altura OE" class="w-full border p-2 rounded mt-2" />
          <input name="longe_oe_adicao" placeholder="Adição OE" class="w-full border p-2 rounded mt-2" />
        </div>
      </div>

      <h2 class="text-lg font-semibold mt-6">PERTO</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h3 class="font-medium">OD</h3>
          <input name="perto_od_esferico" placeholder="Esférico OD" class="w-full border p-2 rounded" />
          <input name="perto_od_cilindrico" placeholder="Cilíndrico OD" class="w-full border p-2 rounded mt-2" />
          <input name="perto_od_eixo" placeholder="Eixo OD" class="w-full border p-2 rounded mt-2" />
          <input name="perto_od_dnp_altura" placeholder="DNP/Altura OD" class="w-full border p-2 rounded mt-2" />
          <input name="perto_od_adicao" placeholder="Adição OD" class="w-full border p-2 rounded mt-2" />
        </div>
        <div>
          <h3 class="font-medium">OE</h3>
          <input name="perto_oe_esferico" placeholder="Esférico OE" class="w-full border p-2 rounded" />
          <input name="perto_oe_cilindrico" placeholder="Cilíndrico OE" class="w-full border p-2 rounded mt-2" />
          <input name="perto_oe_eixo" placeholder="Eixo OE" class="w-full border p-2 rounded mt-2" />
          <input name="perto_oe_dnp_altura" placeholder="DNP/Altura OE" class="w-full border p-2 rounded mt-2" />
          <input name="perto_oe_adicao" placeholder="Adição OE" class="w-full border p-2 rounded mt-2" />
        </div>
      </div>

      <label class="block">Telefone/Contato (DDD):</label>
      <input name="ddd_telefone" placeholder="DDD" class="w-1/4 border p-2 rounded" maxlength="2" required/>
      <input name="telefoneContato" placeholder="Telefone/Contato" class="w-3/4 border p-2 rounded" required/>

      <label class="block"> Fornecedor/Lab:
        <select name="fornecedorLab" class="w-full border p-2 rounded" required>
          <option value="">Selecione o Fornecedor</option>
          <option>BSSILOR</option>
          <option>HOYA</option>
          <option>ZEISS</option>
          <option>LABO</option>
          <option>ORGALENT</option> 
          <option>OESTE DIST.</option>
          <option>WANA DIST.</option>
          <option>PONTES DIST.</option>
          <option>KEILA DIST.</option>
          <option>UNILENTE</option>
          <option>JMB</option>
          <option>MIX OPTICAL</option>
          <option>BENETINS DIST.</option>
        </select>
      </label>

      <label class="block"> Consultor/Vendedor
        <select name="consultorVendedor" class="w-full border p-2 rounded" required>
          <option value="">Selecione o Vendedor(a)</option>
          <option>VITOR MARTINS</option>
          <option>ANA CLAUDIA</option>
          <option>THAISSA EVELYN</option>
          <option>HERICK MARCOS</option>
          <option>VICTOR JUNIOR</option>
          <option>ESTAGIÁRIO(A)</option>
        </select>
      </label>

      <h2 class="text-lg font-semibold mt-6">Produtos</h2>
      <div id="produtos-container" class="space-y-4">
  
        <div class="produto-item border p-4 rounded">
          <h3 class="font-medium">Produto 1</h3>
          <input name="produto_1" placeholder="Produto" class="w-full border p-2 rounded" required/>
          <input name="quant_1" type="number" placeholder="Quantidade" class="w-full border p-2 rounded mt-2" min="0" step="any" required/>
          <input name="descricao_mercadoria_1" placeholder="Descrição Mercadoria" class="w-full border p-2 rounded mt-2" required/>
          <input name="valor_1" type="number" placeholder="Valor" class="w-full border p-2 rounded mt-2" min="0" step="any" required/>
        </div>
      </div>
      <button type="button" id="add-produto" class="bg-green-600 text-white px-4 py-2 rounded">Adicionar Produto</button>

      <label class="block">Forma de Pagamento:
        <select name="pagamento" class="w-full border p-2 rounded" required>
          <option value="">Selecione a Forma de Pagamento</option>
          <option>Dinheiro</option>
          <option>Pix</option>
          <option>Débito</option>
          <option>Crédito</option>
        </select>
      </label>

      <input name="desconto" type="number" placeholder="Desconto (opcional)" class="w-full border p-2 rounded" min="0" step="any"/>

      <input name="numero-ficha" type="number" placeholder="Número da Ficha" class="w-full border p-2 rounded" required>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar PDF</button>
    </form>
  </div>
  <script>
    let produtoCount = 1;
    const maxProdutos = 5;

    document.getElementById("add-produto").addEventListener("click", () => {
      if (produtoCount < maxProdutos) {
        produtoCount++;
        const container = document.getElementById("produtos-container");
        const newItem = document.createElement("div");
        newItem.classList.add("produto-item", "border", "p-4", "rounded");
        newItem.innerHTML = `
          <h3 class="font-medium">Produto ${produtoCount}</h3>
          <input name="produto_${produtoCount}" placeholder="Produto" class="w-full border p-2 rounded" />
          <input name="quant_${produtoCount}" type="number" placeholder="Quantidade" class="w-full border p-2 rounded mt-2" min="0" step="any" />
          <input name="descricao_mercadoria_${produtoCount}" placeholder="Descrição Mercadoria" class="w-full border p-2 rounded mt-2" />
          <input name="valor_${produtoCount}" type="number" placeholder="Valor" class="w-full border p-2 rounded mt-2" min="0" step="any" />
        `;
        container.appendChild(newItem);
      }
      if (produtoCount === maxProdutos) {
        document.getElementById("add-produto").disabled = true;
      }
    });

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      // Calcular Valor Total Produtos
      let totalProdutos = 0;
      for (let i = 1; i <= produtoCount; i++) {
        const valor = parseFloat(data[`valor_${i}`]) || 0;
        totalProdutos += valor;
      }
      data.valorTotalProdutos = totalProdutos.toFixed(2);

      // Calcular Valor Total a Pagar
      const desconto = parseFloat(data.desconto) || 0;
      data.valorTotalPagar = (totalProdutos - desconto).toFixed(2);

      const response = await fetch("/gerar-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    });

    document.getElementById('cpf').addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito

    if (value.length > 11) value = value.slice(0, 11);

    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');

    e.target.value = value;
  });

  document.querySelector('form').addEventListener('submit', function (e) {
    const selectMedico = document.querySelector('select[name="medico"]');
    const inputNovoMedico = document.querySelector('input[name="novo_medico"]');

    if (inputNovoMedico.value.trim() !== '') {
      selectMedico.value = inputNovoMedico.value.trim(); 
    }
  });

  </script>
</body>
</html>

